name: API Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  MYSQL_HOST: 127.0.0.1
  MYSQL_PORT: 3306
  MYSQL_USER: root
  MYSQL_PASS: testpassword
  MYSQL_DB: cosc471

jobs:
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install backend dependencies
        working-directory: ./backend
        run: pnpm install

      - name: Run Unit Tests
        working-directory: ./backend
        run: |
          echo "========================================="
          echo "Running Unit Tests"
          echo "========================================="
          npm run test:unit -- --verbose --coverage
        continue-on-error: false



  integration-tests:
    name: Run All Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: cosc471
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -uroot -ptestpassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        run: npm install -g pnpm



      - name: Install backend dependencies
        working-directory: ./backend
        run: pnpm install

      - name: Environment and System Info
        run: |
          echo "========================================="
          echo "Build Environment Information"
          echo "========================================="
          echo "OS: $(uname -s)"
          echo "Architecture: $(uname -m)"
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "pnpm version: $(pnpm --version)"
          echo "Workspace: ${{ github.workspace }}"
          echo "========================================="
          echo ""

      - name: Install MySQL client
        run: |
          echo "Installing MySQL client tools..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq default-mysql-client
          echo "✓ MySQL client installed"
          which mysql
          which mysqladmin

      - name: Wait for MySQL to be ready
        run: |
          echo "========================================="
          echo "Waiting for MySQL Database"
          echo "========================================="
          echo "Checking MySQL client tools..."
          for cmd in mysqladmin mysql; do
            if command -v $cmd >/dev/null 2>&1; then
              echo "✓ $cmd available"
            else
              echo "✗ $cmd NOT available"
            fi
          done

          echo ""
          echo "Attempting MySQL connection..."
          for i in {1..60}; do
            if mysqladmin ping -h"127.0.0.1" -P3306 -uroot -ptestpassword --silent 2>/dev/null; then
              echo "✓ MySQL is ready! (attempt $i)"
              break
            fi
            if [ $((i % 10)) -eq 0 ]; then
              echo "Waiting for MySQL... ($i/60 seconds)"
            fi
            sleep 1
          done

          # Final verification
          if ! mysqladmin ping -h"127.0.0.1" -P3306 -uroot -ptestpassword --silent 2>/dev/null; then
            echo "✗ ERROR: MySQL failed to become ready after 60 seconds"
            exit 1
          fi
          echo "✓ MySQL is healthy and ready"
          echo "========================================="

      - name: Verify schema.sql exists
        working-directory: ./backend
        run: |
          echo "========================================="
          echo "Verifying Database Schema File"
          echo "========================================="
          if [ ! -f ../schema.sql ]; then
            echo "✗ ERROR: ../schema.sql not found"
            echo "Current directory: $(pwd)"
            echo "Parent directory contents:"
            ls -la ..
            exit 1
          fi
          echo "✓ schema.sql found at: $(realpath ../schema.sql)"
          echo "File size: $(stat -f%z ../schema.sql 2>/dev/null || stat --printf='%s' ../schema.sql) bytes"
          echo "First 5 lines of schema.sql:"
          head -n 5 ../schema.sql
          echo "========================================="

      - name: Initialize database schema and seed test data
        working-directory: ./backend
        env:
          MYSQL_HOST: ${{ env.MYSQL_HOST }}
          MYSQL_PORT: ${{ env.MYSQL_PORT }}
          MYSQL_USER: ${{ env.MYSQL_USER }}
          MYSQL_PASS: ${{ env.MYSQL_PASS }}
          MYSQL_DB: ${{ env.MYSQL_DB }}
        run: |
          echo "========================================="
          echo "Initializing Database"
          echo "========================================="
          echo "Target: ${{ env.MYSQL_DB }} at ${{ env.MYSQL_HOST }}:${{ env.MYSQL_PORT }}"
          echo ""
          
          echo "Importing schema into database..."
          if mysql -h${{ env.MYSQL_HOST }} -P${{ env.MYSQL_PORT }} -u${{ env.MYSQL_USER }} -p${{ env.MYSQL_PASS }} ${{ env.MYSQL_DB }} < ../schema.sql; then
            echo "✓ Database schema imported successfully"
          else
            echo "✗ Failed to import schema"
            exit 1
          fi

          echo ""
          echo "Verifying database tables..."
          mysql -h${{ env.MYSQL_HOST }} -P${{ env.MYSQL_PORT }} -u${{ env.MYSQL_USER }} -p${{ env.MYSQL_PASS }} ${{ env.MYSQL_DB }} -e "SHOW TABLES;"
          echo "✓ Database initialization complete"
          echo "========================================="

      - name: Start backend server
        working-directory: ./backend
        env:
          MYSQL_HOST: ${{ env.MYSQL_HOST }}
          MYSQL_PORT: ${{ env.MYSQL_PORT }}
          MYSQL_USER: ${{ env.MYSQL_USER }}
          MYSQL_PASS: ${{ env.MYSQL_PASS }}
          MYSQL_DB: ${{ env.MYSQL_DB }}
          PORT: 5000
        run: |
          echo "========================================="
          echo "Starting Backend Server"
          echo "========================================="
          echo "Environment:"
          echo "  Database: ${{ env.MYSQL_DB }}"
          echo "  Host: ${{ env.MYSQL_HOST }}:${{ env.MYSQL_PORT }}"
          echo "  Port: 5000"
          echo ""
          
          npm start > /tmp/backend-server.log 2>&1 &
          SERVER_PID=$!
          echo $SERVER_PID > /tmp/backend-server.pid
          echo "✓ Backend server started with PID: $SERVER_PID"
          sleep 3
          
          if ps -p $SERVER_PID > /dev/null; then
            echo "✓ Backend process is running"
          else
            echo "✗ Backend process failed to start"
            cat /tmp/backend-server.log
            exit 1
          fi
          echo "========================================="

      - name: Show initial backend logs
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "Backend Server Initial Logs (first 50 lines)"
          echo "========================================="
          if [ -f /tmp/backend-server.log ]; then
            head -n 50 /tmp/backend-server.log
          else
            echo "No logs found yet"
          fi
          echo "========================================="

      - name: Wait for backend to be ready (HTTP check)
        run: |
          echo "========================================="
          echo "Waiting for Backend HTTP Server"
          echo "========================================="
          TIMEOUT=60
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if curl -sSf http://localhost:5000/ping >/dev/null 2>&1; then
              echo "✓ Backend is ready and responding to ping!"
              break
            fi
            
            ELAPSED=$((ELAPSED + 1))
            if [ $((ELAPSED % 10)) -eq 0 ]; then
              echo "Waiting for backend... ($ELAPSED/$TIMEOUT seconds)"
            fi
            sleep 1
          done

          # Final verification
          echo ""
          echo "Verifying backend health..."
          if curl -sSf http://localhost:5000/ping >/dev/null 2>&1; then
            echo "✓ Backend is healthy and ready for tests"
            curl -sSf http://localhost:5000/ping | head -c 100
            echo ""
            echo "========================================="
          else
            echo "✗ ERROR: Backend failed to become ready after $TIMEOUT seconds"
            echo ""
            echo "========================================="
            echo "Backend Server Logs:"
            echo "========================================="
            cat /tmp/backend-server.log
            exit 1
          fi

      - name: Run Authentication Tests
        id: auth-tests
        working-directory: ./backend
        env:
          API_URL: http://localhost:5000
        run: |
          echo ""
          echo "========================================="
          echo "Test Suite: Authentication"
          echo "========================================="
          npm run test:integration:auth
        continue-on-error: true

      - name: Run Classes Tests
        id: classes-tests
        working-directory: ./backend
        env:
          API_URL: http://localhost:5000
        run: |
          echo ""
          echo "========================================="
          echo "Test Suite: Classes"
          echo "========================================="
          npm run test:integration:classes
        continue-on-error: true

      - name: Run Assignments Tests
        id: assignments-tests
        working-directory: ./backend
        env:
          API_URL: http://localhost:5000
        run: |
          echo ""
          echo "========================================="
          echo "Test Suite: Assignments"
          echo "========================================="
          npm run test:integration:assignments
        continue-on-error: true

      - name: Run Groups Tests
        id: groups-tests
        working-directory: ./backend
        env:
          API_URL: http://localhost:5000
        run: |
          echo ""
          echo "========================================="
          echo "Test Suite: Groups"
          echo "========================================="
          npm run test:integration:groups
        continue-on-error: true

      - name: Run Rubrics & Reviews Tests
        id: rubrics-tests
        working-directory: ./backend
        env:
          API_URL: http://localhost:5000
        run: |
          echo ""
          echo "========================================="
          echo "Test Suite: Rubrics & Reviews"
          echo "========================================="
          npm run test:integration:rubrics
        continue-on-error: true

      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "INTEGRATION TEST SUMMARY"
          echo "========================================="
          echo ""
          echo "Test Suites Executed:"
          echo "  1. Authentication Tests:  ${{ steps.auth-tests.outcome }}"
          echo "  2. Classes Tests:         ${{ steps.classes-tests.outcome }}"
          echo "  3. Assignments Tests:     ${{ steps.assignments-tests.outcome }}"
          echo "  4. Groups Tests:          ${{ steps.groups-tests.outcome }}"
          echo "  5. Rubrics & Reviews:     ${{ steps.rubrics-tests.outcome }}"
          echo ""
          echo "========================================="
          echo "Test Results Breakdown:"
          echo "========================================="
          
          PASSED=0
          FAILED=0
          
          [ "${{ steps.auth-tests.outcome }}" = "success" ] && ((PASSED++)) || ((FAILED++))
          [ "${{ steps.classes-tests.outcome }}" = "success" ] && ((PASSED++)) || ((FAILED++))
          [ "${{ steps.assignments-tests.outcome }}" = "success" ] && ((PASSED++)) || ((FAILED++))
          [ "${{ steps.groups-tests.outcome }}" = "success" ] && ((PASSED++)) || ((FAILED++))
          [ "${{ steps.rubrics-tests.outcome }}" = "success" ] && ((PASSED++)) || ((FAILED++))
          
          echo "✓ Passed: $PASSED"
          echo "✗ Failed: $FAILED"
          echo "Total:   5"
          echo ""
          echo "========================================="
          
          if [ $FAILED -eq 0 ]; then
            echo "✓ ALL TESTS PASSED!"
          else
            echo "✗ SOME TESTS FAILED - See above for details"
          fi
          echo "========================================="

      - name: Display backend logs on failure
        if: failure()
        run: |
          echo ""
          echo "========================================="
          echo "FAILURE DIAGNOSTICS"
          echo "========================================="
          echo ""
          
          echo "========================================="
          echo "Backend Server Logs (Full)"
          echo "========================================="
          if [ -f /tmp/backend-server.log ]; then
            wc -l /tmp/backend-server.log
            echo "---"
            cat /tmp/backend-server.log
          else
            echo "No logs found"
          fi

          echo ""
          echo "========================================="
          echo "Backend Process Status"
          echo "========================================="
          if [ -f /tmp/backend-server.pid ]; then
            PID=$(cat /tmp/backend-server.pid)
            echo "Expected PID: $PID"
            if ps -p $PID > /dev/null; then
              echo "✓ Process is still running"
              ps -p $PID -o pid,vsz,rss,cmd
            else
              echo "✗ Process has exited"
            fi
          else
            echo "No PID file found"
          fi

          echo ""
          echo "========================================="
          echo "Network Status (Port 5000)"
          echo "========================================="
          sudo netstat -tlnp 2>/dev/null | grep :5000 || echo "Port 5000 not in use"
          echo ""
          echo "Testing connectivity:"
          curl -sSv http://localhost:5000/ping || echo "Failed to connect"

          echo ""
          echo "========================================="
          echo "Available Logs in /tmp"
          echo "========================================="
          ls -lah /tmp/*.log 2>/dev/null || echo "No log files found"



      - name: Cleanup
        if: always()
        run: |
          echo "========================================="
          echo "Cleanup"
          echo "========================================="
          if [ -f /tmp/backend-server.pid ]; then
            PID=$(cat /tmp/backend-server.pid)
            kill $PID 2>/dev/null || true
            echo "Backend server stopped"
          fi
